<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solicitar Servicio - CargaFácil</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <header></header>

  <main class="hero">
    <form id="form-servicio">
      <label for="tipo-servicio">Tipo de servicio:</label>
      <select id="tipo-servicio" name="tipo-servicio" required>
        <option value="grua">Grúa</option>
        <option value="flete">Flete</option>
      </select>

      <label for="origen">Ubicación de recogida:</label>
      <input id="origen" name="origen" type="text" placeholder="Ej. Barrio Cabañas" required />
      <button type="button" onclick="usarUbicacion('origen')">📍 Usar mi ubicación</button>

      <label for="destino">Destino:</label>
      <input id="destino" name="destino" type="text" placeholder="Ej. Colonia El Álamo" required />
      <button type="button" onclick="usarUbicacion('destino')">📍 Usar mi ubicación</button>

      <div id="campos-dinamicos"></div>

      <button type="submit">Calcular costo estimado</button>
    </form>

    <div id="resultado" style="margin-top: 1.5rem;"></div>
  </main>

  <footer></footer>

  <script src="script/includeHeaderFooter.js"></script>
  <script>
    let autocompleteOrigen, autocompleteDestino;
    const paisesPermitidos = ['Honduras', 'Guatemala', 'El Salvador'];

    function initAutocomplete() {
      autocompleteOrigen = new google.maps.places.Autocomplete(document.getElementById('origen'));
      autocompleteDestino = new google.maps.places.Autocomplete(document.getElementById('destino'));
    }

    function usarUbicacion(inputId) {
      if (!navigator.geolocation) return alert("Tu navegador no permite geolocalización.");
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ location: { lat, lng } }, (results, status) => {
          if (status === 'OK') {
            const pais = results[0].address_components.find(c => c.types.includes("country")).long_name;
            if (!paisesPermitidos.includes(pais)) {
              return alert(`Actualmente solo operamos en Honduras, Guatemala y El Salvador (Detectado: ${pais})`);
            }
            document.getElementById(inputId).value = results[0].formatted_address;
          } else {
            alert("No se pudo obtener la dirección.");
          }
        });
      }, () => {
        alert("No se pudo obtener tu ubicación.");
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const tipoServicio = document.getElementById("tipo-servicio");
      const camposDinamicos = document.getElementById("campos-dinamicos");

      tipoServicio.addEventListener("change", () => {
        const tipo = tipoServicio.value;
        camposDinamicos.innerHTML = tipo === "grua"
          ? `<label for="vehiculo">Tipo de vehículo:</label><input type="text" id="vehiculo" name="vehiculo" required />`
          : `<label for="carga">Tipo de carga:</label><input type="text" id="carga" name="carga" required />`;
      });

      document.getElementById("form-servicio").addEventListener("submit", function (e) {
        e.preventDefault();
        const origen = document.getElementById("origen").value;
        const destino = document.getElementById("destino").value;

        const service = new google.maps.DirectionsService();
        service.route({
          origin: origen,
          destination: destino,
          travelMode: google.maps.TravelMode.DRIVING,
          drivingOptions: {
            departureTime: new Date(),
            trafficModel: 'best_guess'
          }
        }, (result, status) => {
          if (status === "OK") {
            const duracionSegundos = result.routes[0].legs[0].duration_in_traffic.value;
            const minutos = Math.ceil(duracionSegundos / 60);
            const tarifa = 17;
            const total = minutos * tarifa;
            document.getElementById("resultado").innerHTML = `<strong>Duración estimada:</strong> ${minutos} minutos<br><strong>Total:</strong> L ${total}`;
          } else {
            alert("No se pudo calcular la ruta: " + status);
          }
        });
      });
    });
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCVU55Fqklut8xkmurlbdzOhlQd78pbVMM&libraries=places&callback=initAutocomplete" async defer></script>
</body>
</html>
